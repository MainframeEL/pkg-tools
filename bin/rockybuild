#!/bin/sh

ARCH=`uname -m`

while getopts :hm: opt; do
    case "$opt" in
        m)
            MODULE="$OPTARG"
        ;;
        h)
            echo "USAGE: $0 (-m MODULE:STREAM) (mock options)"
            echo
        ;;
        *)
            true
        ;;
    esac
done

if [ -z "$MODULE" ]; then
    if basename $PWD | grep -q "^r8-"; then 
        echo "ERROR: This branch seems to be a module, append '-m MODULE:STREAM' to the rockybuild command"
        exit 255
    fi
    MOCKCONFIG="/etc/mock/rocky.$ARCH/baseos.cfg"
else
    if [ -f "/etc/mock/rocky.$ARCH/modules/$MODULE.cfg" ]; then
        MOCKCONFIG="/etc/mock/rocky.$ARCH/modules/$MODULE.cfg"
        shift
    else
        echo "ERROR: Could not find module config for: '$MODULE'"
        exit 255
    fi
fi
    
set -xe

createrepo /usr/share/nginx/html/repo

rpmbuild -bs --nodeps --define "%_topdir `pwd`" --define "dist .el8" SPECS/*.spec

touch /tmp/mock-include.tpl

mock -r "$MOCKCONFIG" --resultdir=`pwd` SRPMS/*.src.rpm --cleanup-after  "$@"

cp *.rpm SRPMS/*.src.rpm /usr/share/nginx/html/repo/

createrepo /usr/share/nginx/html/repo

