#!/bin/sh

set -xe

SOURCEDIR=`ls -d _work/* 2>/dev/null | head -n 1`

if [ -z "$SOURCEDIR" ]; then
    echo "ERROR: no working directory found, run 'rockyprep' first"
    exit 255
fi

test -d _patch && rm -rf _patch

mkdir _patch

rpmbuild --quiet -bp --nodeps --define "%_topdir `pwd`" --define "_builddir `pwd`/_patch" --define "dist .el8" SPECS/*.spec >/dev/null

PATCHDIR=`cd _patch; ls -d * 2>/dev/null | head -n 1`

ln -s "../$SOURCEDIR" _patch/a
ln -s "$PATCHDIR" _patch/b

( cd _patch; diff -ru a b ) ||:

rm -rf _patch

set +x
